<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mason.YZU Studio - Vanilla</title>
    
    <!-- 1. CSS Framework & Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;800&family=Rajdhani:wght@500;600;700&display=swap" rel="stylesheet">
    <!-- Tailwind Configuration -->
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              game: {
                bg: '#0b1120',
                surface: '#1e293b',
                primary: '#06b6d4',
                accent: '#f43f5e',
                text: '#f1f5f9',
                muted: '#94a3b8',
                success: '#10b981',
              }
            },
            fontFamily: {
              sans: ['"Rajdhani"', '"Nunito"', 'sans-serif'],
              mono: ['"Fira Code"', 'monospace'],
            },
            boxShadow: {
              'neon': '0 0 10px rgba(6, 182, 212, 0.5), 0 0 20px rgba(6, 182, 212, 0.3)',
              'neon-red': '0 0 10px rgba(244, 63, 94, 0.5), 0 0 20px rgba(244, 63, 94, 0.3)',
            }
          }
        }
      }
    </script>
    <style>
        /* WIX COMPATIBILITY FIXES */
        html, body {
            height: 100%;
            width: 100%;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
            overflow-y: auto;
            background-color: #0b1120;
        }
        
        .app-container {
            min-height: 100%;
            display: flex;
            flex-direction: column;
        }
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #06b6d4; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #22d3ee; }
        
        /* Step Transitions */
        .step-section {
            display: none; /* Hidden by default */
            flex-direction: column;
            flex: 1;
            animation: fadeIn 0.3s ease-in-out;
        }
        .step-section.active {
            display: flex;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Cropper Overrides */
        .cropper-view-box, .cropper-face {
            border-radius: 0;
            outline-color: #06b6d4;
        }
        .cropper-line, .cropper-point {
            background-color: #06b6d4;
        }
        .cropper-bg {
            background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQAQMAAAAlPW0iAAAAA3NCSVQICAjb4U/gAAAABlBMVEX///8AAABVwtN+AAAAAnRSTlMA/1uRIrUAAAAJcEhZcwAACxMAAAsTAQCanBgAAAAKSURBVAjXY2AAAAACAAHiIbwzAAAAAElFTkSuQmCC');
        }
    </style>
    <!-- 2. JS Libraries (Loaded synchronously) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body class="bg-game-bg text-game-text font-sans antialiased">
    <div class="app-container max-w-4xl mx-auto p-2 md:p-4 relative">
        <!-- Background Grid -->
        <div class="fixed inset-0 pointer-events-none opacity-20 z-0" 
             style="background-image: linear-gradient(rgba(6, 182, 212, 0.1) 1px, transparent 1px), linear-gradient(90deg, rgba(6, 182, 212, 0.1) 1px, transparent 1px); background-size: 40px 40px; mask-image: radial-gradient(circle at center, black, transparent 90%);">
        </div>
        <!-- Header -->
        <header class="shrink-0 flex justify-between items-center mb-2 border-b border-game-surface pb-2 z-10 relative">
            <div class="flex flex-col">
                <h1 class="text-2xl md:text-3xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-game-primary to-cyan-100 tracking-tighter font-[Rajdhani] drop-shadow-neon">
                    Mason.YZU Studio
                </h1>
                <p class="text-[10px] text-game-muted font-mono leading-none mt-1">
                    SYSTEM ONLINE // Pure JS
                </p>
            </div>
            <!-- Progress Indicators -->
            <div class="flex items-center gap-1" id="progress-bar">
                <div id="prog-1" class="h-1.5 w-6 md:w-8 rounded-sm bg-game-surface/30 skew-x-[-12deg] transition-colors duration-300"></div>
                <div id="prog-2" class="h-1.5 w-6 md:w-8 rounded-sm bg-game-surface/30 skew-x-[-12deg] transition-colors duration-300"></div>
                <div id="prog-3" class="h-1.5 w-6 md:w-8 rounded-sm bg-game-surface/30 skew-x-[-12deg] transition-colors duration-300"></div>
                <div id="prog-4" class="h-1.5 w-6 md:w-8 rounded-sm bg-game-surface/30 skew-x-[-12deg] transition-colors duration-300"></div>
            </div>
        </header>
        <!-- Main Content Card -->
        <main class="flex-1 bg-game-surface/30 backdrop-blur-md rounded-lg shadow-2xl border border-game-surface ring-1 ring-white/5 relative flex flex-col overflow-hidden z-10" style="min-height: 500px;">
            
            <!-- Decorations -->
            <div class="absolute top-0 left-0 w-3 h-3 border-t-2 border-l-2 border-game-primary -translate-x-0.5 -translate-y-0.5"></div>
            <div class="absolute top-0 right-0 w-3 h-3 border-t-2 border-r-2 border-game-primary -translate-y-0.5 translate-x-0.5"></div>
            <div class="absolute bottom-0 left-0 w-3 h-3 border-b-2 border-l-2 border-game-primary translate-y-0.5 -translate-x-0.5"></div>
            <div class="absolute bottom-0 right-0 w-3 h-3 border-b-2 border-r-2 border-game-primary translate-y-0.5 translate-x-0.5"></div>
            <div class="flex-1 flex flex-col p-3 md:p-6 relative" id="main-content">
                
                <!-- STEP 1: UPLOAD -->
                <div id="step-upload" class="step-section active justify-center items-center h-full">
                    <div class="flex flex-col items-center justify-center w-full h-full border-2 border-dashed border-game-primary/30 rounded-xl p-6 text-center bg-game-surface/20 hover:bg-game-surface/40 transition-colors cursor-pointer" onclick="document.getElementById('file-input').click()">
                        <div class="relative w-20 h-20 mb-6 group">
                            <div class="absolute inset-0 bg-game-primary/20 rounded-xl animate-pulse group-hover:bg-game-primary/30 transition-colors"></div>
                            <div class="absolute inset-0 flex items-center justify-center border-2 border-game-primary rounded-xl shadow-neon group-hover:scale-105 transition-transform">
                                <i data-lucide="scan-line" class="w-10 h-10 text-game-primary"></i>
                            </div>
                        </div>
                        <h2 class="text-2xl font-bold text-game-text mb-2 tracking-widest uppercase font-[Rajdhani]">INITIALIZE UPLOAD</h2>
                        <p class="text-game-muted text-sm mb-8 max-w-xs">Select target image for tactical slicing.</p>
                        <input type="file" id="file-input" accept="image/*" class="hidden">
                        <button class="font-bold py-3 px-5 rounded-lg bg-game-primary border-2 border-game-primary text-black hover:bg-cyan-300 shadow-neon flex items-center gap-2 uppercase tracking-wider">
                            <i data-lucide="upload" class="w-5 h-5"></i> SELECT_FILE.EXE
                        </button>
                    </div>
                </div>
                <!-- STEP 2: CROP -->
                <div id="step-crop" class="step-section h-full">
                    <div class="shrink-0 flex items-center justify-between border-b border-game-surface pb-2 mb-2">
                        <div>
                            <h3 class="text-lg font-bold text-game-primary flex items-center gap-2 uppercase tracking-wider font-[Rajdhani]">
                                <i data-lucide="scissors" class="w-5 h-5"></i> Stage 1: Extract
                            </h3>
                        </div>
                        <button onclick="window.App.reset()" class="text-xs text-game-muted hover:text-white flex items-center px-2 py-1 rounded border border-transparent hover:border-game-muted">
                            <i data-lucide="ban" class="w-3 h-3 mr-1"></i> ABORT
                        </button>
                    </div>
                    <div class="flex-1 relative bg-black/50 rounded-lg overflow-hidden flex items-center justify-center" style="min-height: 300px;">
                        <!-- Image for CropperJS -->
                        <img id="image-to-crop" src="" style="display: block; max-width: 100%; max-height: 60vh;">
                    </div>
                    <div class="shrink-0 flex justify-end pt-3">
                        <button onclick="window.App.confirmCrop()" class="font-bold py-2 px-6 rounded-lg bg-game-primary text-black hover:bg-cyan-300 shadow-neon flex items-center gap-2 uppercase tracking-wider">
                            <i data-lucide="check-circle" class="w-4 h-4"></i> CONFIRM_ZONE
                        </button>
                    </div>
                </div>
                <!-- STEP 3: GRID SETUP -->
                <div id="step-grid" class="step-section h-full">
                    <div class="flex flex-col lg:flex-row gap-4 h-full">
                        <!-- Preview Area -->
                        <div class="flex-1 bg-black/40 p-4 rounded-xl border border-game-surface flex items-center justify-center relative overflow-hidden">
                            <div class="relative shadow-2xl z-10" style="max-height: 60vh;">
                                <img id="grid-preview-img" src="" class="max-w-full max-h-full object-contain border border-game-surface rounded" style="max-height: 60vh;">
                                <!-- Grid Overlay -->
                                <div id="grid-overlay" class="absolute inset-0 border border-game-primary/50 pointer-events-none z-20 transition-all duration-200"></div>
                            </div>
                        </div>
                        <!-- Controls -->
                        <div class="shrink-0 w-full lg:w-64 flex flex-col gap-3">
                            <div class="border-b border-game-surface pb-2">
                                <h3 class="text-lg font-bold text-game-primary uppercase tracking-wider font-[Rajdhani] flex items-center gap-2">
                                    <i data-lucide="grid-3x3" class="w-5 h-5"></i> Stage 2: Grid
                                </h3>
                            </div>
                            <!-- Vertical Controls -->
                            <div class="bg-game-surface/50 p-2 rounded border border-game-surface">
                                <label class="block text-[10px] font-bold text-game-primary mb-2 uppercase">Vertical (Cols)</label>
                                <div class="flex items-center justify-between gap-2">
                                    <button onclick="window.App.updateGrid('cols', -1)" class="h-8 w-8 bg-game-surface border border-game-primary/30 text-game-primary flex items-center justify-center rounded hover:border-game-primary">
                                        <i data-lucide="minus" class="w-4 h-4"></i>
                                    </button>
                                    <span id="display-cols" class="font-mono text-xl font-bold text-white">2</span>
                                    <button onclick="window.App.updateGrid('cols', 1)" class="h-8 w-8 bg-game-surface border border-game-primary/30 text-game-primary flex items-center justify-center rounded hover:border-game-primary">
                                        <i data-lucide="plus" class="w-4 h-4"></i>
                                    </button>
                                </div>
                            </div>
                            <!-- Horizontal Controls -->
                            <div class="bg-game-surface/50 p-2 rounded border border-game-surface">
                                <label class="block text-[10px] font-bold text-game-accent mb-2 uppercase">Horizontal (Rows)</label>
                                <div class="flex items-center justify-between gap-2">
                                    <button onclick="window.App.updateGrid('rows', -1)" class="h-8 w-8 bg-game-surface border border-game-accent/30 text-game-accent flex items-center justify-center rounded hover:border-game-accent">
                                        <i data-lucide="minus" class="w-4 h-4"></i>
                                    </button>
                                    <span id="display-rows" class="font-mono text-xl font-bold text-white">2</span>
                                    <button onclick="window.App.updateGrid('rows', 1)" class="h-8 w-8 bg-game-surface border border-game-accent/30 text-game-accent flex items-center justify-center rounded hover:border-game-accent">
                                        <i data-lucide="plus" class="w-4 h-4"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="flex justify-between items-center p-3 bg-black/60 border border-game-surface rounded mt-1">
                                <span class="text-xs font-bold text-game-muted uppercase">Total</span>
                                <span id="display-total" class="text-2xl font-mono font-bold text-white">4</span>
                            </div>
                            <div class="flex gap-2 pt-2 mt-auto">
                                <button onclick="window.App.setStep(2)" class="flex-1 py-2 px-3 rounded border border-game-primary text-game-primary hover:bg-game-primary/10 flex items-center justify-center gap-1 text-xs font-bold">
                                    <i data-lucide="arrow-left" class="w-3 h-3"></i> BACK
                                </button>
                                <button onclick="window.App.processSplit()" class="flex-[2] py-2 px-3 rounded bg-game-accent text-white hover:bg-rose-600 flex items-center justify-center gap-1 text-xs font-bold shadow-neon-red">
                                    <i data-lucide="zap" class="w-3 h-3"></i> EXECUTE
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- STEP 4: RESULT -->
                <div id="step-result" class="step-section h-full">
                    <div class="shrink-0 flex flex-col md:flex-row justify-between items-end mb-4 border-b border-game-surface pb-2 gap-2">
                        <div>
                            <h2 class="text-2xl font-bold text-white uppercase tracking-widest font-[Rajdhani]">MISSION COMPLETE</h2>
                            <p class="text-game-primary text-xs font-mono">Output: <span id="result-count">0</span> Segments</p>
                        </div>
                        <div class="flex gap-2 w-full md:w-auto">
                             <button onclick="window.open('https://www.threads.com/@iistone_1', '_blank')" class="h-8 px-3 rounded bg-game-surface border border-game-surface text-game-text hover:bg-slate-700 text-xs font-bold flex items-center gap-2">
                                <i data-lucide="message-circle" class="w-3 h-3"></i> Help
                            </button>
                            <button onclick="window.App.downloadZip()" class="h-8 px-3 rounded bg-game-primary text-black hover:bg-cyan-300 text-xs font-bold flex items-center gap-2 shadow-neon">
                                <i data-lucide="download" class="w-3 h-3"></i> ZIP
                            </button>
                        </div>
                    </div>
                    <div class="flex-1 overflow-y-auto p-3 bg-black/30 rounded-xl border border-game-surface">
                        <div id="results-container" class="grid grid-cols-2 md:grid-cols-4 gap-3">
                            <!-- JS will populate this -->
                        </div>
                    </div>
                    <div class="shrink-0 flex justify-center pt-4">
                        <button onclick="window.App.reset()" class="text-sm w-full md:w-auto py-2 px-6 rounded border border-yellow-400 text-yellow-400 hover:bg-yellow-400 hover:text-black transition-all font-bold tracking-widest flex items-center justify-center gap-2">
                            <i data-lucide="refresh-ccw" class="w-4 h-4"></i> START NEW IMAGE
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="shrink-0 text-center mb-2 bg-black/50 rounded border-t border-game-primary/30 py-2">
                <p class="text-game-primary font-bold font-mono text-xs tracking-wider">DESIGNED BY Mason/YZU-DBA</p>
            </div>
        </main>
    </div>
    <!-- APPLICATION LOGIC -->
    <script>
        // Define App globally
        window.App = {
            state: {
                step: 1,
                originalImage: null, // Image Object
                cropper: null,
                croppedCanvas: null, // Canvas
                rows: 2,
                cols: 2,
                results: [] // Array of { id, dataUrl, filename }
            },
            init: function() {
                // Initialize Icons
                lucide.createIcons();
                // Setup File Input Listener
                document.getElementById('file-input').addEventListener('change', this.handleFileSelect.bind(this));
                
                // Render initial state
                this.renderStep();
            },
            handleFileSelect: function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (evt) => {
                        const img = new Image();
                        img.onload = () => {
                            this.state.originalImage = img;
                            this.setStep(2);
                        };
                        img.src = evt.target.result;
                    };
                    reader.readAsDataURL(file);
                }
            },
            setStep: function(stepNumber) {
                this.state.step = stepNumber;
                this.renderStep();
            },
            renderStep: function() {
                // Hide all steps
                ['step-upload', 'step-crop', 'step-grid', 'step-result'].forEach(id => {
                    document.getElementById(id).classList.remove('active');
                });
                // Update Progress Bar
                for(let i=1; i<=4; i++) {
                    const el = document.getElementById('prog-' + i);
                    if (i <= this.state.step) {
                        el.classList.remove('bg-game-surface/30');
                        el.classList.add('bg-game-primary', 'shadow-neon');
                    } else {
                        el.classList.add('bg-game-surface/30');
                        el.classList.remove('bg-game-primary', 'shadow-neon');
                    }
                }
                // Show current step
                if (this.state.step === 1) {
                    document.getElementById('step-upload').classList.add('active');
                    this.destroyCropper();
                    document.getElementById('file-input').value = ''; // reset input
                }
                else if (this.state.step === 2) {
                    document.getElementById('step-crop').classList.add('active');
                    // Initialize Cropper
                    const imageEl = document.getElementById('image-to-crop');
                    imageEl.src = this.state.originalImage.src;
                    // Wait a tick for DOM to update
                    setTimeout(() => this.initCropper(imageEl), 50);
                }
                else if (this.state.step === 3) {
                    document.getElementById('step-grid').classList.add('active');
                    this.destroyCropper();
                    this.updateGridOverlay();
                    // Set preview image
                    const previewImg = document.getElementById('grid-preview-img');
                    previewImg.src = this.state.croppedCanvas.toDataURL();
                }
                else if (this.state.step === 4) {
                    document.getElementById('step-result').classList.add('active');
                    this.renderResults();
                }
                
                // Re-init icons for any new DOM elements
                setTimeout(() => lucide.createIcons(), 0);
            },
            initCropper: function(imageElement) {
                this.destroyCropper();
                this.state.cropper = new Cropper(imageElement, {
                    viewMode: 1,
                    dragMode: 'move',
                    autoCropArea: 0.9,
                    background: false,
                    responsive: true,
                });
            },
            destroyCropper: function() {
                if (this.state.cropper) {
                    this.state.cropper.destroy();
                    this.state.cropper = null;
                }
            },
            confirmCrop: function() {
                if (!this.state.cropper) return;
                // Get cropped canvas
                this.state.croppedCanvas = this.state.cropper.getCroppedCanvas({
                    imageSmoothingQuality: 'high'
                });
                this.setStep(3);
            },
            updateGrid: function(type, delta) {
                if (type === 'rows') {
                    this.state.rows = Math.max(1, Math.min(20, this.state.rows + delta));
                    document.getElementById('display-rows').innerText = this.state.rows;
                } else {
                    this.state.cols = Math.max(1, Math.min(20, this.state.cols + delta));
                    document.getElementById('display-cols').innerText = this.state.cols;
                }
                this.updateGridOverlay();
            },
            updateGridOverlay: function() {
                const overlay = document.getElementById('grid-overlay');
                overlay.style.display = 'grid';
                overlay.style.gridTemplateColumns = repeat(${this.state.cols}, 1fr);
                overlay.style.gridTemplateRows = repeat(${this.state.rows}, 1fr);
                
                // Clear existing cells
                overlay.innerHTML = '';
                
                // Add cells
                const total = this.state.rows * this.state.cols;
                document.getElementById('display-total').innerText = total;
                
                for (let i = 0; i < total; i++) {
                    const cell = document.createElement('div');
                    cell.className = 'border border-game-primary/30 shadow-[inset_0_0_10px_rgba(6,182,212,0.1)]';
                    overlay.appendChild(cell);
                }
            },
            processSplit: function() {
                const canvas = this.state.croppedCanvas;
                const ctx = canvas.getContext('2d');
                const width = canvas.width;
                const height = canvas.height;
                const rows = this.state.rows;
                const cols = this.state.cols;
                const cellW = width / cols;
                const cellH = height / rows;
                
                this.state.results = [];
                for (let r = 0; r < rows; r++) {
                    for (let c = 0; c < cols; c++) {
                        const cellCanvas = document.createElement('canvas');
                        cellCanvas.width = cellW;
                        cellCanvas.height = cellH;
                        const cellCtx = cellCanvas.getContext('2d');
                        
                        cellCtx.drawImage(
                            canvas, 
                            c  cellW, r  cellH, cellW, cellH, // Source
                            0, 0, cellW, cellH // Dest
                        );
                        
                        this.state.results.push({
                            id: img-${r}-${c},
                            dataUrl: cellCanvas.toDataURL('image/jpeg', 0.95),
                            filename: part_${r+1}_${c+1}.jpg
                        });
                    }
                }
                
                this.setStep(4);
            },
            renderResults: function() {
                const container = document.getElementById('results-container');
                document.getElementById('result-count').innerText = this.state.results.length;
                container.innerHTML = '';
                this.state.results.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'bg-game-surface p-1 rounded border border-game-surface hover:border-game-primary transition-all group relative';
                    div.innerHTML = `
                        <img src="${item.dataUrl}" class="w-full h-auto rounded-sm">
                        <a href="${item.dataUrl}" download="${item.filename}" class="absolute top-2 right-2 bg-game-primary p-1.5 rounded text-black opacity-0 group-hover:opacity-100 transition-opacity shadow-lg hover:bg-white cursor-pointer">
                            <i data-lucide="download" class="w-3 h-3"></i>
                        </a>
                    `;
                    container.appendChild(div);
                });
            },
            downloadZip: function() {
                const zip = new JSZip();
                const folder = zip.folder("split_images");
                
                this.state.results.forEach(item => {
                    const base64 = item.dataUrl.split(',')[1];
                    folder.file(item.filename, base64, { base64: true });
                });
                
                folder.generateAsync({type:"blob"}).then(function(content) {
                    const url = URL.createObjectURL(content);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = "mason_yzu_split_output.zip";
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                });
            },
            reset: function() {
                this.state.step = 1;
                this.state.originalImage = null;
                this.state.croppedCanvas = null;
                this.state.results = [];
                this.renderStep();
            }
        };
        // Start App
        document.addEventListener('DOMContentLoaded', () => {
            window.App.init();
        });
    </script>
</body>
</html>
